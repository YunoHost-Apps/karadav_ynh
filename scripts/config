#!/bin/bash

#=================================================
# GENERIC STARTING
#=================================================
# IMPORT GENERIC HELPERS
#=================================================

source _common.sh
source /usr/share/yunohost/helpers

ynh_abort_if_errors

# import needed settings
phpversion=$(ynh_app_setting_get --app="$app" --key=phpversion)
upload_max_filesize=$(ynh_app_setting_get --app="$app" --key=upload_max_filesize)
post_max_size=$(ynh_app_setting_get --app="$app" --key=post_max_size)

#=================================================
# SPECIFIC SETTERS
#=================================================

set__upload_max_filesize() {

    # update php config
    ynh_add_fpm_config

    # save new settings
    ynh_app_setting_set --app="$app" --key=upload_max_filesize --value="$upload_max_filesize"

}

set__post_max_size() {

    # update php config
    ynh_add_fpm_config

    # update nginx config
    ynh_replace_string --match_string="client_max_body_size .*;" --replace_string="client_max_body_size $post_max_size;" --target_file="/etc/nginx/conf.d/$domain.d/$app.conf"
    ynh_store_file_checksum --file="/etc/nginx/conf.d/$domain.d/$app.conf"

    # save new settings
    ynh_app_setting_set --app="$app" --key=post_max_size --value="$post_max_size"

}

# Keep this last line
ynh_app_config_run "$1"